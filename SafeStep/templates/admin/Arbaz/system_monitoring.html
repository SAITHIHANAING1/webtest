{% extends "base.html" %}

{% block title %}System Monitoring - SAFE-Step Admin{% endblock %}

{% block body_class %}admin-page{% endblock %}

{% block extra_css %}
<style>
/* System Monitoring Specific Styles */
.monitoring-header {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 25px 25px;
    position: relative;
    overflow: hidden;
}

.monitoring-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='m0 40l40-40h-40v40zm40 0v-40h-40l40 40z'/%3E%3C/g%3E%3C/svg%3E");
}

.monitoring-title {
    font-size: 2.5rem;
    font-weight: 900;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
}

.monitoring-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px;
    padding: 2rem;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    margin-bottom: 2rem;
    height: 100%;
}

.monitoring-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
    transform: scaleX(0);
    transition: transform 0.4s ease;
}

.monitoring-card:hover::before {
    transform: scaleX(1);
}

.monitoring-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
}

.status-healthy { background: #48bb78; }
.status-warning { background: #ed8936; }
.status-critical { background: #f56565; }
.status-offline { background: #718096; }

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
    100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
}

.metric-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    transition: transform 0.3s ease;
    transform: scaleX(0);
}

.metric-card:hover::before {
    transform: scaleX(1);
}

.metric-cpu::before { background: linear-gradient(90deg, #fc466b 0%, #3f5efb 100%); }
.metric-memory::before { background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); }
.metric-disk::before { background: linear-gradient(90deg, #fa709a 0%, #fee140 100%); }
.metric-network::before { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); }

.metric-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    margin: 0 auto 1rem;
}

.metric-cpu .metric-icon { background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%); }
.metric-memory .metric-icon { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
.metric-disk .metric-icon { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.metric-network .metric-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #718096;
    font-size: 0.9rem;
}

.service-item {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.service-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.service-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.service-name {
    font-weight: bold;
    color: #2d3748;
}

.service-status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.service-running {
    background: rgba(72, 187, 120, 0.1);
    color: #48bb78;
}

.service-warning {
    background: rgba(237, 137, 54, 0.1);
    color: #ed8936;
}

.service-error {
    background: rgba(245, 101, 101, 0.1);
    color: #f56565;
}

.service-stopped {
    background: rgba(113, 128, 150, 0.1);
    color: #718096;
}

.progress-bar-custom {
    height: 10px;
    background: #e2e8f0;
    border-radius: 5px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-fill {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 5px;
}

.progress-cpu { background: linear-gradient(90deg, #fc466b 0%, #3f5efb 100%); }
.progress-memory { background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); }
.progress-healthy { background: linear-gradient(90deg, #48bb78 0%, #38ef7d 100%); }
.progress-warning { background: linear-gradient(90deg, #ed8936 0%, #fbb040 100%); }
.progress-critical { background: linear-gradient(90deg, #f56565 0%, #fc466b 100%); }

.log-container {
    background: #1a202c;
    color: #e2e8f0;
    border-radius: 10px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    height: 300px;
    overflow-y: auto;
}

.log-entry {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.log-timestamp {
    color: #4fd1c7;
}

.log-level-info { color: #68d391; }
.log-level-warn { color: #f6e05e; }
.log-level-error { color: #fc8181; }
.log-level-debug { color: #a0aec0; }

.action-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.btn-restart {
    background: rgba(237, 137, 54, 0.1);
    color: #ed8936;
}

.btn-restart:hover {
    background: #ed8936;
    color: white;
    transform: translateY(-2px);
}

.btn-stop {
    background: rgba(245, 101, 101, 0.1);
    color: #f56565;
}

.btn-stop:hover {
    background: #f56565;
    color: white;
    transform: translateY(-2px);
}

.btn-start {
    background: rgba(72, 187, 120, 0.1);
    color: #48bb78;
}

.btn-start:hover {
    background: #48bb78;
    color: white;
    transform: translateY(-2px);
}

.chart-container {
    position: relative;
    height: 300px;
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
}

.alert-item {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    border-left: 4px solid transparent;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.alert-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.alert-critical {
    border-left-color: #f56565;
    background: rgba(245, 101, 101, 0.05);
}

.alert-warning {
    border-left-color: #ed8936;
    background: rgba(237, 137, 54, 0.05);
}

.alert-info {
    border-left-color: #4299e1;
    background: rgba(66, 153, 225, 0.05);
}

.refresh-indicator {
    display: inline-block;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.uptime-badge {
    background: linear-gradient(135deg, #48bb78 0%, #38ef7d 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
    display: inline-block;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <i class="fas fa-server me-3"></i>System Monitoring
            </h1>
            <p class="mb-0" style="font-size: 1.1rem; opacity: 0.8; color: #666;">
                Real-time system health and performance monitoring
            </p>
        </div>
        <div class="header-buttons">
            <span class="status-badge status-completed">
                <i class="fas fa-clock me-1"></i>Uptime: 99.8%
            </span>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt me-2" id="refreshIcon"></i>Refresh
            </button>
        </div>
    </div>

    <!-- System Metrics -->
    <div class="metrics-grid" id="metricsGrid">
        <div class="metric-card metric-cpu">
            <div class="metric-icon">
                <i class="fas fa-microchip"></i>
            </div>
            <div class="metric-value" id="cpuValue">--%</div>
            <div class="metric-label">CPU Usage</div>
            <div class="progress-bar-custom">
                <div class="progress-fill progress-cpu" id="cpuProgress" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="cpuDetails">Loading...</small>
        </div>
        
        <div class="metric-card metric-memory">
            <div class="metric-icon">
                <i class="fas fa-memory"></i>
            </div>
            <div class="metric-value" id="memoryValue">--%</div>
            <div class="metric-label">Memory Usage</div>
            <div class="progress-bar-custom">
                <div class="progress-fill progress-memory" id="memoryProgress" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="memoryDetails">Loading...</small>
        </div>
        
        <div class="metric-card metric-disk">
            <div class="metric-icon">
                <i class="fas fa-hdd"></i>
            </div>
            <div class="metric-value" id="diskValue">--%</div>
            <div class="metric-label">Disk Usage</div>
            <div class="progress-bar-custom">
                <div class="progress-fill progress-warning" id="diskProgress" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="diskDetails">Loading...</small>
        </div>
        
        <div class="metric-card metric-network">
            <div class="metric-icon">
                <i class="fas fa-network-wired"></i>
            </div>
            <div class="metric-value" id="networkValue">-- MB/s</div>
            <div class="metric-label">Network Speed</div>
            <div class="progress-bar-custom">
                <div class="progress-fill progress-healthy" id="networkProgress" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="networkDetails">Loading...</small>
        </div>
    </div>

    <!-- Services and Performance -->
    <div class="grid-2">
        <!-- System Services -->
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="h5 mb-0">
                    <i class="fas fa-cogs me-2"></i>System Services
                </h3>
                <button class="btn btn-primary btn-sm" onclick="refreshServices()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
                
                <div class="service-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="service-name">
                                <span class="status-indicator status-healthy"></span>
                                Web Application Server
                            </div>
                            <small class="text-muted">Flask WSGI Server</small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="service-status service-running">Running</span>
                            <button class="action-btn btn-restart" onclick="restartService('webapp')">
                                <i class="fas fa-redo me-1"></i>Restart
                            </button>
                        </div>
                    </div>
                </div>

                <div class="service-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="service-name">
                                <span class="status-indicator status-healthy"></span>
                                Database Server
                            </div>
                            <small class="text-muted">PostgreSQL 14.2</small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="service-status service-running">Running</span>
                            <button class="action-btn btn-restart" onclick="restartService('database')">
                                <i class="fas fa-redo me-1"></i>Restart
                            </button>
                        </div>
                    </div>
                </div>

                <div class="service-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="service-name">
                                <span class="status-indicator status-warning"></span>
                                Redis Cache
                            </div>
                            <small class="text-muted">Redis 6.2.7</small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="service-status service-warning">High Memory</span>
                            <button class="action-btn btn-restart" onclick="restartService('redis')">
                                <i class="fas fa-redo me-1"></i>Restart
                            </button>
                        </div>
                    </div>
                </div>

                <div class="service-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="service-name">
                                <span class="status-indicator status-healthy"></span>
                                AI Prediction Engine
                            </div>
                            <small class="text-muted">TensorFlow Serving</small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="service-status service-running">Running</span>
                            <button class="action-btn btn-restart" onclick="restartService('ai')">
                                <i class="fas fa-redo me-1"></i>Restart
                            </button>
                        </div>
                    </div>
                </div>

                <div class="service-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="service-name">
                                <span class="status-indicator status-critical"></span>
                                Notification Service
                            </div>
                            <small class="text-muted">Celery Worker</small>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="service-status service-error">Error</span>
                            <button class="action-btn btn-start" onclick="startService('notifications')">
                                <i class="fas fa-play me-1"></i>Start
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="h5 mb-0">
                    <i class="fas fa-chart-area me-2"></i>Performance Trends
                </h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm active" data-metric="cpu">CPU</button>
                    <button class="btn btn-outline-secondary btn-sm" data-metric="memory">Memory</button>
                    <button class="btn btn-outline-secondary btn-sm" data-metric="network">Network</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Logs and Alerts -->
    <div class="grid-2">
        <!-- System Logs -->
        <div class="admin-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h5 mb-0">
                        <i class="fas fa-file-alt me-2"></i>System Logs
                    </h3>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" style="width: auto;">
                            <option>All Logs</option>
                            <option>Application</option>
                            <option>Database</option>
                            <option>Security</option>
                            <option>API</option>
                        </select>
                        <button class="btn btn-outline-primary btn-sm" onclick="downloadLogs()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[2024-01-15 14:32:15]</span>
                        <span class="log-level-info">[INFO]</span>
                        <span>Application server started successfully</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">[2024-01-15 14:32:18]</span>
                        <span class="log-level-info">[INFO]</span>
                        <span>Database connection established</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">[2024-01-15 14:35:42]</span>
                        <span class="log-level-warn">[WARN]</span>
                        <span>Redis memory usage approaching limit (85%)</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">[2024-01-15 14:38:12]</span>
                        <span class="log-level-error">[ERROR]</span>
                        <span>Notification service failed to start: Connection timeout</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">[2024-01-15 14:40:05]</span>
                        <span class="log-level-info">[INFO]</span>
                        <span>User login: admin@safestep.com</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-timestamp">[2024-01-15 14:42:33]</span>
                        <span class="log-level-debug">[DEBUG]</span>
                        <span>AI model prediction completed: 23% risk score</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Alerts -->
        <div class="admin-card">
                <h3 class="h5 mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>Active Alerts
                </h3>
                
                <div class="alert-item alert-critical">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1 text-danger">Service Down</h6>
                            <p class="small text-muted mb-1">Notification service is not responding</p>
                            <small class="text-muted">5 minutes ago</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="acknowledgeAlert(1)">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>

                <div class="alert-item alert-warning">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1 text-warning">High Memory Usage</h6>
                            <p class="small text-muted mb-1">Redis cache using 85% of allocated memory</p>
                            <small class="text-muted">12 minutes ago</small>
                        </div>
                        <button class="btn btn-sm btn-outline-warning" onclick="acknowledgeAlert(2)">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>

                <div class="alert-item alert-info">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1 text-info">Backup Completed</h6>
                            <p class="small text-muted mb-1">Daily database backup finished successfully</p>
                            <small class="text-muted">2 hours ago</small>
                        </div>
                        <button class="btn btn-sm btn-outline-info" onclick="acknowledgeAlert(3)">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-card">
                <h3 class="h5 mb-4">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h3>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="runDiagnostics()">
                        <i class="fas fa-stethoscope me-2"></i>Run System Diagnostics
                    </button>
                    
                    <button class="btn btn-outline-primary" onclick="clearCache()">
                        <i class="fas fa-broom me-2"></i>Clear Cache
                    </button>
                    
                    <button class="btn btn-outline-secondary" onclick="backupDatabase()">
                        <i class="fas fa-database me-2"></i>Backup Database
                    </button>
                    
                    <button class="btn btn-outline-warning" onclick="restartAllServices()">
                        <i class="fas fa-power-off me-2"></i>Restart All Services
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// System Monitoring JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadSystemMetrics();
    loadSystemServices();
    loadSystemLogs();
    loadSystemAlerts();
    initializePerformanceChart();
    startAutoRefresh();
    
    // Metric toggle functionality
    document.querySelectorAll('[data-metric]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-metric]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updatePerformanceChart(this.dataset.metric);
        });
    });
});

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['10:00', '10:15', '10:30', '10:45', '11:00', '11:15', '11:30', '11:45', '12:00'],
            datasets: [{
                label: 'CPU Usage (%)',
                data: [25, 28, 32, 29, 35, 38, 32, 30, 32],
                borderColor: '#11998e',
                backgroundColor: 'rgba(17, 153, 142, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    window.performanceChart = chart;
}

function updatePerformanceChart(metric) {
    const chart = window.performanceChart;
    let data, label, color;
    
    switch(metric) {
        case 'cpu':
            data = [25, 28, 32, 29, 35, 38, 32, 30, 32];
            label = 'CPU Usage (%)';
            color = '#11998e';
            break;
        case 'memory':
            data = [60, 62, 65, 68, 70, 68, 67, 69, 68];
            label = 'Memory Usage (%)';
            color = '#fc466b';
            break;
        case 'network':
            data = [120, 135, 142, 138, 145, 140, 142, 139, 142];
            label = 'Response Time (ms)';
            color = '#667eea';
            break;
    }
    
    chart.data.datasets[0].data = data;
    chart.data.datasets[0].label = label;
    chart.data.datasets[0].borderColor = color;
    chart.data.datasets[0].backgroundColor = color + '20';
    chart.update();
}

function startAutoRefresh() {
    setInterval(() => {
        // Update metrics and logs automatically
        loadSystemMetrics();
        loadSystemServices();
        loadSystemLogs();
        loadSystemAlerts();
    }, 30000); // Refresh every 30 seconds
}

// Load real-time system metrics
async function loadSystemMetrics() {
    try {
        const response = await fetch('/admin/api/system/metrics');
        const data = await response.json();
        
        if (data.success) {
            const metrics = data.metrics;
            
            // Update CPU
            if (metrics.cpu) {
                document.getElementById('cpuValue').textContent = metrics.cpu.value + '%';
                document.getElementById('cpuProgress').style.width = metrics.cpu.value + '%';
                document.getElementById('cpuDetails').textContent = `Status: ${metrics.cpu.status}`;
            }
            
            // Update Memory
            if (metrics.memory) {
                document.getElementById('memoryValue').textContent = metrics.memory.value + '%';
                document.getElementById('memoryProgress').style.width = metrics.memory.value + '%';
                document.getElementById('memoryDetails').textContent = `${metrics.memory.used_gb} GB / ${metrics.memory.total_gb} GB`;
            }
            
            // Update Disk
            if (metrics.disk) {
                document.getElementById('diskValue').textContent = metrics.disk.value + '%';
                document.getElementById('diskProgress').style.width = metrics.disk.value + '%';
                document.getElementById('diskDetails').textContent = `${metrics.disk.used_gb} GB / ${metrics.disk.total_gb} GB`;
            }
            
            // Update Network
            if (metrics.network) {
                document.getElementById('networkValue').textContent = metrics.network.value + ' MB/s';
                document.getElementById('networkProgress').style.width = Math.min(100, metrics.network.value * 2) + '%';
                document.getElementById('networkDetails').textContent = `Up: ${(metrics.network.bytes_sent / (1024*1024)).toFixed(1)} MB | Down: ${(metrics.network.bytes_recv / (1024*1024)).toFixed(1)} MB`;
            }
        }
    } catch (error) {
        console.error('Error loading system metrics:', error);
        showNotification('Failed to load system metrics', 'danger');
    }
}

// Load system services status
async function loadSystemServices() {
    try {
        const response = await fetch('/admin/api/system/services');
        const data = await response.json();
        
        if (data.success) {
            // Update services UI - this would need a more complete implementation
            // For now, we'll just log the services data
            console.log('System services loaded:', data.services);
        }
    } catch (error) {
        console.error('Error loading system services:', error);
    }
}

// Load system logs
async function loadSystemLogs() {
    try {
        const response = await fetch('/admin/api/system/logs?limit=20');
        const data = await response.json();
        
        if (data.success) {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            
            data.logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-level-${log.level.toLowerCase()}">[${log.level}]</span>
                    <span>${log.message}</span>
                `;
                
                logContainer.appendChild(logEntry);
            });
        }
    } catch (error) {
        console.error('Error loading system logs:', error);
    }
}

// Load system alerts
async function loadSystemAlerts() {
    try {
        const response = await fetch('/admin/api/system/alerts');
        const data = await response.json();
        
        if (data.success) {
            // Update alerts UI - this would need implementation in the HTML
            console.log('System alerts loaded:', data.alerts);
        }
    } catch (error) {
        console.error('Error loading system alerts:', error);
    }
}

function refreshData() {
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.classList.add('refresh-indicator');
    
    // Load all data
    Promise.all([
        loadSystemMetrics(),
        loadSystemServices(),
        loadSystemLogs(),
        loadSystemAlerts()
    ]).then(() => {
        refreshIcon.classList.remove('refresh-indicator');
        showNotification('System data refreshed successfully', 'success');
    }).catch(error => {
        refreshIcon.classList.remove('refresh-indicator');
        showNotification('Failed to refresh system data', 'danger');
        console.error('Refresh error:', error);
    });
}

function refreshServices() {
    showNotification('Service status updated', 'info');
}

function restartService(serviceName) {
    if (confirm(`Are you sure you want to restart the ${serviceName} service?`)) {
        showNotification(`${serviceName} service restart initiated`, 'warning');
    }
}

function startService(serviceName) {
    showNotification(`Starting ${serviceName} service...`, 'info');
}

function acknowledgeAlert(alertId) {
    showNotification(`Alert ${alertId} acknowledged`, 'success');
}

function runDiagnostics() {
    showNotification('Running system diagnostics...', 'info');
}

function clearCache() {
    if (confirm('Are you sure you want to clear the system cache?')) {
        showNotification('Cache cleared successfully', 'success');
    }
}

function backupDatabase() {
    showNotification('Database backup initiated', 'info');
}

function restartAllServices() {
    if (confirm('Are you sure you want to restart all services? This will cause temporary downtime.')) {
        showNotification('All services restart initiated', 'warning');
    }
}

function downloadLogs() {
    showNotification('Logs export started', 'info');
}

function updateMetrics() {
    // Simulate real-time metric updates
    const cpuValue = document.querySelector('.metric-cpu .metric-value');
    const memoryValue = document.querySelector('.metric-memory .metric-value');
    
    if (cpuValue && memoryValue) {
        const newCpu = Math.floor(Math.random() * 20) + 25; // 25-45%
        const newMemory = Math.floor(Math.random() * 10) + 65; // 65-75%
        
        cpuValue.textContent = newCpu + '%';
        memoryValue.textContent = newMemory + '%';
    }
}

function updateLogs() {
    const logContainer = document.getElementById('logContainer');
    const newLogEntry = document.createElement('div');
    newLogEntry.className = 'log-entry';
    
    const now = new Date();
    const timestamp = now.toISOString().slice(0, 19).replace('T', ' ');
    
    newLogEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-level-info">[INFO]</span>
        <span>System health check completed</span>
    `;
    
    logContainer.insertBefore(newLogEntry, logContainer.firstChild);
    
    // Keep only last 20 entries
    while (logContainer.children.length > 20) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}