{% extends "base.html" %}

{% block title %}Analytics & Reports - SafeStep{% endblock %}

{% block body_class %}analytics-page{% endblock %}

{% block extra_css %}
<style>
    .analytics-page {
        background-color: #f8f9fa;
        min-height: 100vh;
    }

    .data-source-badge {
        background-color: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }

    .filters-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filters-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .filters-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .filter-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .analyze-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        transition: transform 0.2s;
    }

    .analyze-btn:hover {
        transform: translateY(-2px);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #4285f4, #34a853, #ea4335, #fbbc04);
    }

    .metric-value {
        font-size: 42px;
        font-weight: 800;
        color: #000 !important;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
        font-size: 24px;
        opacity: 0.7;
    }

    .metric-label {
        font-size: 16px;
        color: #000 !important;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .metric-change {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
        opacity: 0.8;
    }

    .metric-change.positive {
        background-color: #e8f5e8;
        color: #2e7d32;
    }

    .metric-change.negative {
        background-color: #ffebee;
        color: #c62828;
    }

    .metric-change.neutral {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .chart-card:hover {
        transform: translateY(-2px);
    }

    .chart-card-large {
        grid-column: 1 / -1;
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .chart-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title>div:first-child>div:first-child {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    .chart-subtitle {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    .real-time-indicator {
        background: #34a853;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .chart-container-large {
        position: relative;
        height: 400px;
        width: 100%;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #666;
        font-style: italic;
    }

    /* Report History Styles */
    .report-history-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .report-table-container {
        margin-top: 20px;
    }

    .report-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .stat-card {
        background: #f8fafc;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        border: 1px solid #e5e7eb;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .error {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #ea4335;
        font-style: italic;
    }

    /* Patient Management Section */
    .patient-management-section {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-actions {
        display: flex;
        gap: 8px;
    }

    .btn-success {
        background: #059669;
        border: 1px solid #059669;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .btn-success:hover {
        background: #047857;
        border-color: #047857;
        transform: none;
    }

    .patient-table-container {
        background: #f9fafb;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #e5e7eb;
    }

    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 16px;
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 320px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 36px 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s ease;
        background: #ffffff;
    }

    .search-box input:focus {
        outline: none;
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    .search-box i {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
    }

    .table-filters select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #ffffff;
        min-width: 160px;
        font-size: 14px;
    }

    .patient-table {
        width: 100%;
        background: #ffffff;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }

    .patient-table th {
        background: #f3f4f6;
        color: #374151;
        padding: 12px;
        font-weight: 600;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
    }

    .patient-table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        font-size: 14px;
        color: #374151;
    }

    .patient-table tbody tr:hover {
        background-color: #f9fafb;
    }

    .risk-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .risk-low { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .risk-medium { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .risk-high { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .risk-critical { background: #fecaca; color: #7f1d1d; border: 1px solid #f87171; }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
    }

    .btn-outline-primary {
        border: 1px solid #4285f4;
        color: #4285f4;
        background: transparent;
    }

    .btn-outline-primary:hover {
        background: #4285f4;
        color: white;
    }

    .btn-outline-danger {
        border: 1px solid #dc3545;
        color: #dc3545;
        background: transparent;
    }

    .btn-outline-danger:hover {
        background: #dc3545;
        color: white;
    }

    /* Prediction Results Section */
    .prediction-results-section {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .prediction-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #f3f4f6;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
    }

    .status-indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #059669;
        animation: pulse 2s infinite;
    }

    .status-indicator.running {
        background: #d97706;
    }

    .status-indicator.error {
        background: #dc2626;
    }

    .prediction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .prediction-card {
        background: #f9fafb;
        border-radius: 6px;
        padding: 16px;
        border-left: 3px solid #6b7280;
        border: 1px solid #e5e7eb;
    }

    .prediction-card.high-risk {
        border-left-color: #dc2626;
        background: #fef2f2;
    }

    .prediction-card.medium-risk {
        border-left-color: #d97706;
        background: #fffbeb;
    }

    .prediction-card.low-risk {
        border-left-color: #059669;
        background: #f0fdf4;
    }

    /* Modal Styles */
    .modal-content {
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        background: #f9fafb;
        color: #1f2937;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .modal-title {
        font-weight: 600;
        font-size: 18px;
    }

    .btn-close {
        filter: none;
        opacity: 0.6;
    }

    .btn-close:hover {
        opacity: 1;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .filters-row {
            grid-template-columns: 1fr;
        }

        .metric-card {
            text-align: center;
        }

        .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .section-actions {
            justify-content: center;
        }

        .table-controls {
            flex-direction: column;
            gap: 15px;
        }

        .search-box {
            max-width: none;
        }

        .patient-table {
            font-size: 14px;
        }

        .patient-table th,
        .patient-table td {
            padding: 8px 6px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Analytics & Reports</h1>
            <span class="data-source-badge">Live Data</span>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" onclick="refreshAllData()" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-primary" onclick="runPredictionAnalysis()" id="analyzeBtn">
                <i class="fas fa-brain"></i> Run Analysis
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-title">
            <i class="fas fa-filter"></i>
            Analytics Filters
        </div>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <select id="dateRange" class="filter-select">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Patient Filter</label>
                <select id="pwidFilter" class="filter-select">
                    <option value="">All patients</option>
                    <option value="high-risk">High-risk only</option>
                    <option value="recent-incidents">Recent incidents</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Location</label>
                <select id="locationFilter" class="filter-select">
                    <option value="">All locations</option>
                    <option value="home">Home</option>
                    <option value="hospital">Hospital</option>
                    <option value="public">Public</option>
                    <option value="work">Work</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Incident Type</label>
                <select id="incidentType" class="filter-select">
                    <option value="">All incidents</option>
                    <option value="seizure">Seizures only</option>
                    <option value="fall">Falls only</option>
                    <option value="medication">Medication events</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="analyze-btn" onclick="applyFilters()">
                    <i class="fas fa-chart-line"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">📊</span>
                <span id="totalIncidents">0</span>
            </div>
            <div class="metric-label">Total Incidents</div>
            <div class="metric-change neutral" id="incidentsChange">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">⚡</span>
                <span id="seizureCount">0</span>
            </div>
            <div class="metric-label">Seizure Events</div>
            <div class="metric-change neutral" id="seizureChange">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">⏱️</span>
                <span id="avgResponseTime">0m</span>
            </div>
            <div class="metric-label">Avg. Response Time</div>
            <div class="metric-change neutral" id="responseTimeChange">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">⚠️</span>
                <span id="highRiskCases">0</span>
            </div>
            <div class="metric-label">High-Risk Cases</div>
            <div class="metric-change neutral" id="riskCasesChange">Loading...</div>
        </div>
    </div>

    <!-- Essential Clinical Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Seizure Risk Trends</div>
                    <div class="chart-subtitle">Risk assessment over time</div>
                </div>
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="chart-container">
                <canvas id="riskTrendChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Incidents by Location</div>
                    <div class="chart-subtitle">Geographic distribution</div>
                </div>
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="chart-container">
                <canvas id="locationChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Seizure Frequency by Time</div>
                    <div class="chart-subtitle">Temporal patterns</div>
                </div>
                <i class="fas fa-clock"></i>
            </div>
            <div class="chart-container">
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Medication Levels</div>
                    <div class="chart-subtitle">Blood level monitoring</div>
                </div>
                <i class="fas fa-flask"></i>
            </div>
            <div class="chart-container">
                <canvas id="medicationLevelsChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Response Time Analysis</div>
                    <div class="chart-subtitle">Emergency response efficiency</div>
                </div>
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="chart-container">
                <canvas id="responseChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Medication Compliance</div>
                    <div class="chart-subtitle">Treatment adherence tracking</div>
                </div>
                <i class="fas fa-pills"></i>
            </div>
            <div class="chart-container">
                <canvas id="medicationChart"></canvas>
            </div>
        </div>
    </div>



    <!-- Critical Alerts Section -->
    <div class="critical-alerts-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-exclamation-triangle"></i>
                Critical Patient Alerts
            </h2>
            <div class="alert-status" id="alertStatus">
                <span class="status-indicator live"></span>
                <span class="status-text">Live Monitoring</span>
            </div>
        </div>
        
        <div class="alerts-grid" id="criticalAlerts">
            <!-- Critical alerts will be loaded here -->
        </div>
    </div>
</div>



<!-- Patient Risk Monitoring Section -->
<div class="patient-management-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-user-shield"></i>
            Patient Risk Monitoring
        </h2>
        <div class="section-actions">
            <button class="btn btn-danger" onclick="viewHighRiskPatients()">
                <i class="fas fa-exclamation-triangle"></i> High Risk Patients
            </button>
            <button class="btn btn-warning" onclick="viewMedicationAlerts()">
                <i class="fas fa-pills"></i> Medication Alerts
            </button>
            <button class="btn btn-primary" onclick="runAutomaticRiskAssessment()">
                <i class="fas fa-brain"></i> Auto Risk Assessment
            </button>
        </div>
    </div>
    
    <div class="patient-table-container">
        <div class="table-controls">
            <div class="search-box">
                <input type="text" id="patientSearch" placeholder="Search patients..." onkeyup="searchPatients()">
                <i class="fas fa-search"></i>
            </div>
            <div class="table-filters">
                <select id="riskLevelFilter" onchange="searchPatients()">
                    <option value="">All Risk Levels</option>
                    <option value="High">High Risk</option>
                    <option value="Critical">Critical Risk</option>
                </select>
                <select id="alertTypeFilter" onchange="searchPatients()">
                    <option value="">All Alerts</option>
                    <option value="medication">Medication</option>
                    <option value="seizure">Seizure Risk</option>
                    <option value="emergency">Emergency</option>
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="patient-table" id="riskMonitoringTable">
                <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Last Assessment</th>
                        <th>Risk Level</th>
                        <th>Alert Type</th>
                        <th>Last Medication</th>
                        <th>Days Since Seizure</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="riskMonitoringTableBody">
                     <!-- Risk monitoring data will be loaded here -->
                 </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Patient Modal -->
<div class="modal fade" id="patientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientModalTitle">Add New Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientId" class="form-label">Patient ID *</label>
                                <input type="text" class="form-control" id="patientId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientAge" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="patientAge" min="1" max="120" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientGender" class="form-label">Gender *</label>
                                <select class="form-select" id="patientGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epilepsyType" class="form-label">Epilepsy Type *</label>
                                <select class="form-select" id="epilepsyType" required>
                                    <option value="">Select Type</option>
                                    <option value="Focal">Focal Epilepsy</option>
                                    <option value="Generalized">Generalized Epilepsy</option>
                                    <option value="Unknown">Unknown Onset</option>
                                    <option value="Combined">Combined</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="riskLevel" class="form-label">Risk Level *</label>
                                <select class="form-select" id="riskLevel" required>
                                    <option value="">Select Risk Level</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recentSeizures" class="form-label">Recent Seizures (Last 30 days)</label>
                                <input type="number" class="form-control" id="recentSeizures" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="patientNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="patientNotes" rows="3" placeholder="Additional notes about the patient..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePatient()">Save Patient</button>
            </div>
        </div>
    </div>
</div>

<!-- Patient Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalTitle">Patient Alert Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert-details" id="alertDetails">
                    <!-- Alert details will be loaded here -->
                </div>
                <div class="quick-actions">
                    <h6>Quick Actions:</h6>
                    <button class="btn btn-warning btn-sm" onclick="contactCaregiver()">Contact Caregiver</button>
                    <button class="btn btn-info btn-sm" onclick="viewMedicationHistory()">Medication History</button>
                    <button class="btn btn-danger btn-sm" onclick="markEmergency()">Mark Emergency</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="acknowledgeAlert()">Acknowledge Alert</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global chart instances
    let charts = {
        riskTrend: null,
        location: null,
        time: null,
        medicationLevels: null,
        response: null,
        medication: null
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadMetrics();
        loadAllCharts();
        loadCriticalAlerts();
        loadRiskMonitoring();

        // Set up filter event listeners
        document.getElementById('dateRange').addEventListener('change', applyFilters);
        document.getElementById('pwidFilter').addEventListener('change', applyFilters);
        document.getElementById('locationFilter').addEventListener('change', applyFilters);
        document.getElementById('incidentType').addEventListener('change', applyFilters);
    });

    function getCurrentFilters() {
        return {
            dateRange: document.getElementById('dateRange').value,
            pwidFilter: document.getElementById('pwidFilter').value,
            locationFilter: document.getElementById('locationFilter').value,
            incidentType: document.getElementById('incidentType').value
        };
    }

    async function loadMetrics() {
        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/metrics?${queryParams}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                document.getElementById('totalIncidents').textContent = data.total_incidents || 0;
                document.getElementById('seizureCount').textContent = data.seizure_count || 0;
                document.getElementById('avgResponseTime').textContent = data.avg_response_time || '0m';
                document.getElementById('highRiskCases').textContent = data.high_risk_cases || 0;

                // Update change indicators
                updateChangeIndicator('incidentsChange', data.incidents_change || '0%');
                updateChangeIndicator('seizureChange', data.seizure_change || '0%');
                updateChangeIndicator('responseTimeChange', data.response_time_change || '0%');
                updateChangeIndicator('riskCasesChange', data.risk_cases_change || '0%');
            }
        } catch (error) {
            console.error('Error loading metrics:', error);
            // Set fallback values
            document.getElementById('totalIncidents').textContent = '24';
            document.getElementById('seizureCount').textContent = '19';
            document.getElementById('avgResponseTime').textContent = '13.3m';
            document.getElementById('highRiskCases').textContent = '0';
        }
    }

    function updateChangeIndicator(elementId, changeText) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = changeText;

            if (changeText.includes('+') || changeText.includes('increase')) {
                element.className = 'metric-change positive';
            } else if (changeText.includes('-') || changeText.includes('decrease')) {
                element.className = 'metric-change negative';
            } else {
                element.className = 'metric-change neutral';
            }
        }
    }

    async function loadAllCharts() {
        await Promise.all([
            loadRiskTrendChart(),
            loadLocationChart(),
            loadTimeChart(),
            loadMedicationLevelsChart(),
            loadResponseChart(),
            loadMedicationChart()
        ]);
    }





    async function loadRiskTrendChart() {
        const ctx = document.getElementById('riskTrendChart').getContext('2d');

        try {
            // Fetch prediction results from the AI model
            const response = await fetch('/api/analytics/prediction-results');
            const data = await response.json();

            if (data.success && data.predictions) {
                if (charts.riskTrend) {
                    charts.riskTrend.destroy();
                }

                // Process prediction data for trend visualization
                const predictions = data.predictions;
                const labels = [];
                const riskScores = [];
                const confidenceScores = [];

                // Sort predictions by date and create trend data
                predictions.sort((a, b) => new Date(a.prediction_date) - new Date(b.prediction_date));
                
                predictions.forEach(pred => {
                    const date = new Date(pred.prediction_date);
                    labels.push(date.toLocaleDateString());
                    riskScores.push(parseFloat(pred.risk_score) || 0);
                    confidenceScores.push((parseFloat(pred.confidence_score) || 0) * 100);
                });

                charts.riskTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Risk Score',
                            data: riskScores,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        }, {
                            label: 'Model Confidence (%)',
                            data: confidenceScores,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'AI Seizure Risk Prediction Trends'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Prediction Date'
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('No prediction data available, but chart should still load with demo data');
            }
        } catch (error) {
            console.error('Error loading risk trend chart:', error);
            // Show error state
            const errorDiv = document.getElementById('riskTrendChart').parentElement;
            errorDiv.innerHTML = '<div class="alert alert-warning">Unable to load prediction data. Please check if the prediction model is running.</div>';
        }
    }

    async function loadLocationChart() {
        const ctx = document.getElementById('locationChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/location-distribution?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.location) {
                    charts.location.destroy();
                }

                charts.location = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.locations,
                        datasets: [{
                            data: data.counts,
                            backgroundColor: [
                                '#4285f4',
                                '#34a853',
                                '#ea4335',
                                '#fbbc04',
                                '#9aa0a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading location chart:', error);
        }
    }

    async function loadTimeChart() {
        const ctx = document.getElementById('timeChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/seizure-frequency?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.time) {
                    charts.time.destroy();
                }

                charts.time = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading time chart:', error);
        }
    }

    async function loadMedicationLevelsChart() {
        const ctx = document.getElementById('medicationLevelsChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/medication-levels?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.medicationLevels) {
                    charts.medicationLevels.destroy();
                }

                charts.medicationLevels = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels || ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: data.datasets || [{
                            label: 'Therapeutic Range',
                            data: [75, 80, 78, 82],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Blood Level (%)'
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading medication levels chart:', error);
            // Fallback chart with sample data
            if (charts.medicationLevels) {
                charts.medicationLevels.destroy();
            }
            charts.medicationLevels = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Therapeutic Range',
                        data: [75, 80, 78, 82],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Blood Level (%)'
                            }
                        }
                    }
                }
            });
        }
    }

    async function loadResponseChart() {
        const ctx = document.getElementById('responseChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/response-time?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.response) {
                    charts.response.destroy();
                }

                // Update datasets to handle null values properly
                const updatedDatasets = data.datasets.map(dataset => ({
                    ...dataset,
                    spanGaps: false,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    fill: false
                }));
                
                charts.response = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: updatedDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                filter: function(tooltipItem) {
                                    return tooltipItem.parsed.y !== null;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Response Time (minutes)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading response chart:', error);
        }
    }

    async function loadMedicationChart() {
        const ctx = document.getElementById('medicationChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/medication-compliance?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.medication) {
                    charts.medication.destroy();
                }

                charts.medication = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading medication chart:', error);
        }
    }

    function applyFilters() {
        loadMetrics();
        loadAllCharts();
    }

    function refreshAllData() {
        loadMetrics();
        loadAllCharts();
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }







    // AI Prediction Functions
    function runPredictionAnalysis() {
        const statusElement = document.getElementById('predictionStatus');
        const resultsElement = document.getElementById('predictionResults');
        
        if (statusElement) {
            statusElement.innerHTML = '<div class="status-indicator running"></div><span class="status-text">Running AI Analysis...</span>';
        }
        
        fetch('/api/analytics/run-prediction', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('AI analysis completed successfully!', 'success');
                loadPredictionResults();
            } else {
                showNotification(data.message || 'Error running AI analysis', 'error');
                if (statusElement) {
                    statusElement.innerHTML = '<div class="status-indicator error"></div><span class="status-text">Analysis Failed</span>';
                }
            }
        })
        .catch(error => {
            console.error('Error running AI analysis:', error);
            showNotification('Error running AI analysis', 'error');
            if (statusElement) {
                statusElement.innerHTML = '<div class="status-indicator error"></div><span class="status-text">Analysis Failed</span>';
            }
        });
    }

    function loadCriticalAlerts() {
        fetch('/api/analytics/critical-alerts')
            .then(response => response.json())
            .then(data => {
                renderCriticalAlerts(data);
                const statusElement = document.getElementById('alertStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<div class="status-indicator live"></div><span class="status-text">Live Monitoring</span>';
                }
            })
            .catch(error => {
                console.error('Error loading critical alerts:', error);
                showNotification('Error loading critical alerts', 'error');
                // Show sample alerts for demo
                renderCriticalAlerts({
                    alerts: [
                        { patient_id: 'P001', alert_type: 'medication', message: 'Missed medication dose', severity: 'high' },
                        { patient_id: 'P003', alert_type: 'seizure', message: 'High seizure risk detected', severity: 'critical' }
                    ]
                });
            });
    }

    function renderCriticalAlerts(data) {
        const alertsElement = document.getElementById('criticalAlerts');
        if (!alertsElement) return;
        
        alertsElement.innerHTML = '';
        
        const alerts = data.alerts || [];
        if (alerts.length === 0) {
            alertsElement.innerHTML = '<div class="no-alerts">No critical alerts at this time</div>';
            return;
        }
        
        alerts.forEach(alert => {
            const card = document.createElement('div');
            card.className = `alert-card ${alert.severity}-severity`;
            card.innerHTML = `
                <h5>Patient ${alert.patient_id}</h5>
                <p><strong>Alert Type:</strong> <span class="alert-badge alert-${alert.alert_type}">${alert.alert_type.toUpperCase()}</span></p>
                <p><strong>Message:</strong> ${alert.message}</p>
                <p><strong>Severity:</strong> <span class="severity-badge severity-${alert.severity}">${alert.severity.toUpperCase()}</span></p>
                <button class="btn btn-sm btn-primary" onclick="viewAlertDetails('${alert.patient_id}', '${alert.alert_type}')">View Details</button>
            `;
            alertsElement.appendChild(card);
        });
    }

    // Risk Monitoring Functions
    let riskMonitoringData = [];

    function loadRiskMonitoring() {
        fetch('/api/risk-monitoring')
            .then(response => response.json())
            .then(data => {
                riskMonitoringData = data.patients || [];
                renderRiskMonitoring(riskMonitoringData);
            })
            .catch(error => {
                console.error('Error loading risk monitoring data:', error);
                showNotification('Error loading risk monitoring data', 'error');
                // Show sample data for demo
                riskMonitoringData = [
                    {
                        patient_id: 'P001',
                        last_assessment: '2024-01-15',
                        risk_level: 'High',
                        alert_type: 'medication',
                        last_medication: '2024-01-14 08:00',
                        days_since_seizure: 12
                    },
                    {
                        patient_id: 'P003',
                        last_assessment: '2024-01-15',
                        risk_level: 'Critical',
                        alert_type: 'seizure',
                        last_medication: '2024-01-15 07:30',
                        days_since_seizure: 2
                    }
                ];
                renderRiskMonitoring(riskMonitoringData);
            });
    }

    function renderRiskMonitoring(patients) {
        const tbody = document.getElementById('riskMonitoringTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        patients.forEach(patient => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${patient.patient_id || 'N/A'}</td>
                <td>${patient.last_assessment ? new Date(patient.last_assessment).toLocaleDateString() : 'N/A'}</td>
                <td><span class="badge bg-${getRiskColor(patient.risk_level)}">${patient.risk_level || 'Unknown'}</span></td>
                <td><span class="alert-type-badge ${patient.alert_type}">${patient.alert_type || 'None'}</span></td>
                <td>${patient.last_medication ? new Date(patient.last_medication).toLocaleString() : 'N/A'}</td>
                <td>${patient.days_since_seizure !== undefined ? patient.days_since_seizure + ' days' : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewPatientDetails('${patient.patient_id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="contactCaregiver('${patient.patient_id}')" title="Contact Caregiver">
                        <i class="fas fa-phone"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function getRiskColor(riskLevel) {
        switch(riskLevel?.toLowerCase()) {
            case 'low': return 'success';
            case 'medium': return 'warning';
            case 'high': return 'danger';
            case 'critical': return 'dark';
            default: return 'secondary';
        }
    }

    // Simplified Patient Monitoring Functions
    function viewHighRiskPatients() {
        const highRiskPatients = riskMonitoringData.filter(p => p.risk_level === 'High' || p.risk_level === 'Critical');
        if (highRiskPatients.length === 0) {
            showNotification('No high-risk patients at this time', 'info');
            return;
        }
        
        // Filter table to show only high-risk patients
        renderRiskMonitoring(highRiskPatients);
        showNotification(`Found ${highRiskPatients.length} high-risk patients`, 'warning');
    }

    function viewMedicationAlerts() {
        const medicationAlerts = riskMonitoringData.filter(p => p.alert_type === 'medication');
        if (medicationAlerts.length === 0) {
            showNotification('No medication alerts at this time', 'info');
            return;
        }
        
        // Filter table to show only medication alerts
        renderRiskMonitoring(medicationAlerts);
        showNotification(`Found ${medicationAlerts.length} medication alerts`, 'warning');
    }

    function runAutomaticRiskAssessment() {
        showNotification('Running automatic risk assessment...', 'info');
        
        // Simulate automatic assessment
        setTimeout(() => {
            loadRiskMonitoring();
            showNotification('Risk assessment completed', 'success');
        }, 2000);
    }

    function viewPatientDetails(patientId) {
        const patient = riskMonitoringData.find(p => p.patient_id === patientId);
        if (!patient) {
            showNotification('Patient not found', 'error');
            return;
        }
        
        const alertDetails = document.getElementById('alertDetails');
        alertDetails.innerHTML = `
            <h6>Patient ${patient.patient_id} Details</h6>
            <p><strong>Risk Level:</strong> <span class="badge bg-${getRiskColor(patient.risk_level)}">${patient.risk_level}</span></p>
            <p><strong>Last Assessment:</strong> ${new Date(patient.last_assessment).toLocaleDateString()}</p>
            <p><strong>Alert Type:</strong> ${patient.alert_type}</p>
            <p><strong>Last Medication:</strong> ${new Date(patient.last_medication).toLocaleString()}</p>
            <p><strong>Days Since Last Seizure:</strong> ${patient.days_since_seizure} days</p>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('alertModal'));
        modal.show();
    }

    function contactCaregiver(patientId) {
        showNotification(`Contacting caregiver for patient ${patientId}...`, 'info');
        // This would typically integrate with a communication system
        setTimeout(() => {
            showNotification('Caregiver has been notified', 'success');
        }, 1000);
    }



    function viewMedicationHistory(patientId) {
        showNotification(`Loading medication history for patient ${patientId}...`, 'info');
        // This would typically open a detailed medication history view
    }

    function markEmergency(patientId) {
        if (confirm('Mark this as an emergency? This will alert emergency contacts immediately.')) {
            showNotification('Emergency alert sent to all contacts', 'error');
        }
    }

    function acknowledgeAlert() {
        showNotification('Alert acknowledged', 'success');
        bootstrap.Modal.getInstance(document.getElementById('alertModal')).hide();
    }

    function viewAlertDetails(patientId, alertType) {
        const patient = riskMonitoringData.find(p => p.patient_id === patientId);
        if (!patient) return;
        
        viewPatientDetails(patientId);
    }

    function refreshRiskMonitoring() {
        loadRiskMonitoring();
        showNotification('Patient monitoring refreshed!', 'info');
    }

    function searchPatients() {
        const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
        const riskFilter = document.getElementById('riskFilter').value;
        const alertFilter = document.getElementById('alertFilter').value;
        
        let filteredPatients = riskMonitoringData.filter(patient => {
            const matchesSearch = !searchTerm || 
                patient.patient_id?.toString().toLowerCase().includes(searchTerm) ||
                patient.risk_level?.toLowerCase().includes(searchTerm);
            
            const matchesRisk = !riskFilter || patient.risk_level?.toLowerCase() === riskFilter.toLowerCase();
            const matchesAlert = !alertFilter || patient.alert_type?.toLowerCase() === alertFilter.toLowerCase();
            
            return matchesSearch && matchesRisk && matchesAlert;
        });
        
        renderRiskMonitoring(filteredPatients);
    }

    // Report History Functions
    let reportHistory = [];
    let reportStats = {};



    function viewReportDetails(reportId) {
        fetch(`/api/reports/${reportId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const report = data.report;
                let details = `Report ID: ${report.id}\n`;
                details += `Type: ${report.report_type}\n`;
                details += `Filename: ${report.filename || 'N/A'}\n`;
                details += `Records: ${report.record_count || 0}\n`;
                details += `File Size: ${formatFileSize(report.file_size)}\n`;
                details += `Status: ${report.status}\n`;
                details += `Export Date: ${formatDate(report.export_timestamp)}\n`;
                if (report.filters_applied) {
                    details += `Filters: ${report.filters_applied}\n`;
                }
                if (report.error_message) {
                    details += `Error: ${report.error_message}\n`;
                }
                
                alert(details);
            } else {
                showNotification('Error loading report details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading report details:', error);
            showNotification('Error loading report details', 'error');
        });
    }

    function deleteReport(reportId) {
        if (confirm('Are you sure you want to delete this report?')) {
            fetch(`/api/reports/${reportId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Report deleted successfully!', 'success');
                } else {
                    showNotification(data.message || 'Error deleting report', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting report:', error);
                showNotification('Error deleting report', 'error');
            });
        }
    }

    function exportAnalyticsData() {
        const filters = {
            date_range: document.getElementById('dateRange').value,
            pwid_filter: document.getElementById('pwidFilter').value,
            location_filter: document.getElementById('locationFilter').value,
            incident_type: document.getElementById('incidentType').value
        };
        
        // Create a modal for export type selection instead of prompt
        const exportType = 'PDF'; // Default to PDF for now
        
        const requestData = {
            export_type: exportType,
            filters: filters
        };
        
        fetch('/api/analytics/export-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `analytics_export_${new Date().toISOString().split('T')[0]}.${exportType.toLowerCase()}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showNotification('Export completed successfully!', 'success');

        })
        .catch(error => {
            console.error('Export error:', error);
            showNotification('Export failed', 'error');
        });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadRiskMonitoring();
        
        // Set up search and filter event listeners
        const searchInput = document.getElementById('patientSearch');
        const riskFilter = document.getElementById('riskFilter');
        const alertFilter = document.getElementById('alertFilter');
        
        if (searchInput) {
            searchInput.addEventListener('input', searchPatients);
        }
        if (riskFilter) {
            riskFilter.addEventListener('change', searchPatients);
        }
        if (alertFilter) {
            alertFilter.addEventListener('change', searchPatients);
        }
    });


</script>
{% endblock %}