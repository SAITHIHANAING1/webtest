{% extends "base.html" %}

{% block title %}Analytics & Reports - SafeStep{% endblock %}

{% block body_class %}analytics-page{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        padding: 20px 30px;
        background-color: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .page-title {
        font-size: 32px;
        font-weight: 800;
        color: #000 !important;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        letter-spacing: -0.5px;
    }

    .header-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
    }

    .btn-primary:hover {
        filter: brightness(0.95);
        color: #fff;
    }

    .data-source-badge {
        background: linear-gradient(135deg, #34a853 0%, #4285f4 100%);
        color: #fff;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }

    .filters-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .filters-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filters-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-label {
        font-size: 13px;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-select {
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        background-color: #fff;
        transition: border-color 0.2s;
    }

    .filter-select:focus {
        outline: none;
        border-color: #4285f4;
    }

    .analyze-btn {
        background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        transition: transform 0.2s;
    }

    .analyze-btn:hover {
        transform: translateY(-2px);
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #4285f4, #34a853, #ea4335, #fbbc04);
    }

    .metric-value {
        font-size: 42px;
        font-weight: 800;
        color: #000 !important;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
        font-size: 24px;
        opacity: 0.7;
    }

    .metric-label {
        font-size: 16px;
        color: #000 !important;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .metric-change {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-block;
        opacity: 0.8;
    }

    .metric-change.positive {
        background-color: #e8f5e8;
        color: #2e7d32;
    }

    .metric-change.negative {
        background-color: #ffebee;
        color: #c62828;
    }

    .metric-change.neutral {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .chart-card:hover {
        transform: translateY(-2px);
    }

    .chart-card-large {
        grid-column: 1 / -1;
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
    }

    .chart-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title>div:first-child>div:first-child {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    .chart-subtitle {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    .real-time-indicator {
        background: #34a853;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .chart-container-large {
        position: relative;
        height: 400px;
        width: 100%;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #666;
        font-style: italic;
    }

    .error {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #ea4335;
        font-style: italic;
    }

    /* Patient Management Section */
    .patient-management-section {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-actions {
        display: flex;
        gap: 8px;
    }

    .btn-success {
        background: #059669;
        border: 1px solid #059669;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .btn-success:hover {
        background: #047857;
        border-color: #047857;
        transform: none;
    }

    .patient-table-container {
        background: #f9fafb;
        border-radius: 6px;
        padding: 16px;
        border: 1px solid #e5e7eb;
    }

    .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 16px;
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 320px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 36px 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s ease;
        background: #ffffff;
    }

    .search-box input:focus {
        outline: none;
        border-color: #059669;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    .search-box i {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
    }

    .table-filters select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #ffffff;
        min-width: 160px;
        font-size: 14px;
    }

    .patient-table {
        width: 100%;
        background: #ffffff;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }

    .patient-table th {
        background: #f3f4f6;
        color: #374151;
        padding: 12px;
        font-weight: 600;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
    }

    .patient-table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        font-size: 14px;
        color: #374151;
    }

    .patient-table tbody tr:hover {
        background-color: #f9fafb;
    }

    .risk-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .risk-low { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .risk-medium { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .risk-high { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .risk-critical { background: #fecaca; color: #7f1d1d; border: 1px solid #f87171; }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 4px;
    }

    .btn-outline-primary {
        border: 1px solid #4285f4;
        color: #4285f4;
        background: transparent;
    }

    .btn-outline-primary:hover {
        background: #4285f4;
        color: white;
    }

    .btn-outline-danger {
        border: 1px solid #dc3545;
        color: #dc3545;
        background: transparent;
    }

    .btn-outline-danger:hover {
        background: #dc3545;
        color: white;
    }

    /* Prediction Results Section */
    .prediction-results-section {
        background: #ffffff;
        border-radius: 8px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
    }

    .prediction-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #f3f4f6;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
    }

    .status-indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #059669;
        animation: pulse 2s infinite;
    }

    .status-indicator.running {
        background: #d97706;
    }

    .status-indicator.error {
        background: #dc2626;
    }

    .prediction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .prediction-card {
        background: #f9fafb;
        border-radius: 6px;
        padding: 16px;
        border-left: 3px solid #6b7280;
        border: 1px solid #e5e7eb;
    }

    .prediction-card.high-risk {
        border-left-color: #dc2626;
        background: #fef2f2;
    }

    .prediction-card.medium-risk {
        border-left-color: #d97706;
        background: #fffbeb;
    }

    .prediction-card.low-risk {
        border-left-color: #059669;
        background: #f0fdf4;
    }

    /* Modal Styles */
    .modal-content {
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        background: #f9fafb;
        color: #1f2937;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .modal-title {
        font-weight: 600;
        font-size: 18px;
    }

    .btn-close {
        filter: none;
        opacity: 0.6;
    }

    .btn-close:hover {
        opacity: 1;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .filters-row {
            grid-template-columns: 1fr;
        }

        .metric-card {
            text-align: center;
        }

        .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .section-actions {
            justify-content: center;
        }

        .table-controls {
            flex-direction: column;
            gap: 15px;
        }

        .search-box {
            max-width: none;
        }

        .patient-table {
            font-size: 14px;
        }

        .patient-table th,
        .patient-table td {
            padding: 8px 6px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Analytics & Reports</h1>
        <div class="header-buttons">
            <span class="data-source-badge">Live Data</span>
            <button class="btn btn-primary" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-title">
            <i class="fas fa-filter"></i>
            Analytics Filters
        </div>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <select id="dateRange" class="filter-select">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Patient Filter</label>
                <select id="pwidFilter" class="filter-select">
                    <option value="">All patients</option>
                    <option value="high-risk">High-risk only</option>
                    <option value="recent-incidents">Recent incidents</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Location</label>
                <select id="locationFilter" class="filter-select">
                    <option value="">All locations</option>
                    <option value="home">Home</option>
                    <option value="hospital">Hospital</option>
                    <option value="public">Public</option>
                    <option value="work">Work</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Incident Type</label>
                <select id="incidentType" class="filter-select">
                    <option value="">All incidents</option>
                    <option value="seizure">Seizures only</option>
                    <option value="fall">Falls only</option>
                    <option value="medication">Medication events</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="analyze-btn" onclick="applyFilters()">
                    <i class="fas fa-chart-line"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">üìä</span>
                <span id="totalIncidents">0</span>
            </div>
            <div class="metric-label">Total Incidents</div>
            <div class="metric-change neutral" id="incidentsChange">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">‚ö°</span>
                <span id="seizureCount">0</span>
            </div>
            <div class="metric-label">Seizure Events</div>
            <div class="metric-change neutral" id="seizureChange">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">‚è±Ô∏è</span>
                <span id="avgResponseTime">0m</span>
            </div>
            <div class="metric-label">Avg. Response Time</div>
            <div class="metric-change neutral" id="responseTimeChange">Loading...</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">
                <span class="metric-icon">‚ö†Ô∏è</span>
                <span id="highRiskCases">0</span>
            </div>
            <div class="metric-label">High-Risk Cases</div>
            <div class="metric-change neutral" id="riskCasesChange">Loading...</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="chart-card-large">
        <div class="chart-title">
            <div>
                <div>Seizure Risk Trends</div>
                <div class="chart-subtitle">AI-powered risk analysis over time</div>
            </div>
            <div class="real-time-indicator">LIVE</div>
        </div>
        <div class="chart-container-large">
            <canvas id="riskTrendChart"></canvas>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Incidents by Location</div>
                    <div class="chart-subtitle">Distribution analysis</div>
                </div>
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="chart-container">
                <canvas id="locationChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Seizure Frequency by Time</div>
                    <div class="chart-subtitle">24-hour pattern analysis</div>
                </div>
                <i class="fas fa-clock"></i>
            </div>
            <div class="chart-container">
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Risk Factors Radar</div>
                    <div class="chart-subtitle">Multi-dimensional risk assessment</div>
                </div>
                <i class="fas fa-chart-radar"></i>
            </div>
            <div class="chart-container">
                <canvas id="radarChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Response Time Analysis</div>
                    <div class="chart-subtitle">Emergency response efficiency</div>
                </div>
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="chart-container">
                <canvas id="responseChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <div>
                    <div>Medication Compliance</div>
                    <div class="chart-subtitle">Treatment adherence tracking</div>
                </div>
                <i class="fas fa-pills"></i>
            </div>
            <div class="chart-container">
                <canvas id="medicationChart"></canvas>
            </div>
        </div>
    </div>



    <!-- AI Prediction Results Section -->
    <div class="prediction-results-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-brain"></i>
                AI Prediction Results
            </h2>
            <div class="prediction-status" id="predictionStatus">
                <span class="status-indicator"></span>
                <span class="status-text">Ready</span>
            </div>
        </div>
        
        <div class="prediction-grid" id="predictionResults">
            <!-- Prediction results will be loaded here -->
        </div>
    </div>
</div>

<!-- Seizure Predictions Database Section -->
<div class="patient-management-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-brain"></i>
            Seizure Predictions Database
        </h2>
        <div class="section-actions">
            <button class="btn btn-success" onclick="openPredictionModal()">
                <i class="fas fa-plus"></i> Add Prediction
            </button>
            <button class="btn btn-outline-primary" onclick="refreshPredictions()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-primary" onclick="runPredictionAnalysis()">
                <i class="fas fa-brain"></i> Run AI Analysis
            </button>
        </div>
    </div>
    
    <div class="patient-table-container">
        <div class="table-controls">
            <div class="search-box">
                <input type="text" id="predictionSearch" placeholder="Search predictions..." onkeyup="searchPredictions()">
                <i class="fas fa-search"></i>
            </div>
            <div class="table-filters">
                <select id="predictionRiskFilter" onchange="searchPredictions()">
                    <option value="">All Risk Levels</option>
                    <option value="Low">Low Risk</option>
                    <option value="Medium">Medium Risk</option>
                    <option value="High">High Risk</option>
                    <option value="Critical">Critical Risk</option>
                </select>
                <select id="predictionTimeFilter" onchange="searchPredictions()">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="patient-table" id="seizurePredictionsTable">
                <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Prediction Date</th>
                        <th>Risk Level</th>
                        <th>Risk Score</th>
                        <th>Next Seizure</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="seizurePredictionsTableBody">
                     <!-- Predictions will be loaded here -->
                 </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Patient Modal -->
<div class="modal fade" id="patientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="patientModalTitle">Add New Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientId" class="form-label">Patient ID *</label>
                                <input type="text" class="form-control" id="patientId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientAge" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="patientAge" min="1" max="120" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientGender" class="form-label">Gender *</label>
                                <select class="form-select" id="patientGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epilepsyType" class="form-label">Epilepsy Type *</label>
                                <select class="form-select" id="epilepsyType" required>
                                    <option value="">Select Type</option>
                                    <option value="Focal">Focal Epilepsy</option>
                                    <option value="Generalized">Generalized Epilepsy</option>
                                    <option value="Unknown">Unknown Onset</option>
                                    <option value="Combined">Combined</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="riskLevel" class="form-label">Risk Level *</label>
                                <select class="form-select" id="riskLevel" required>
                                    <option value="">Select Risk Level</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recentSeizures" class="form-label">Recent Seizures (Last 30 days)</label>
                                <input type="number" class="form-control" id="recentSeizures" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="patientNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="patientNotes" rows="3" placeholder="Additional notes about the patient..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePatient()">Save Patient</button>
            </div>
        </div>
    </div>
</div>

<!-- Seizure Prediction Modal -->
<div class="modal fade" id="predictionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="predictionModalTitle">Add New Seizure Prediction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="predictionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionPatientId" class="form-label">Patient ID *</label>
                                <input type="text" class="form-control" id="predictionPatientId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionRiskScore" class="form-label">Risk Score (0-100) *</label>
                                <input type="number" class="form-control" id="predictionRiskScore" min="0" max="100" step="0.1" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="predictionRiskLevel" class="form-label">Risk Level *</label>
                                <select class="form-select" id="predictionRiskLevel" required>
                                    <option value="">Select Risk Level</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nextSeizurePrediction" class="form-label">Next Seizure Prediction</label>
                                <input type="text" class="form-control" id="nextSeizurePrediction" placeholder="e.g., 24 hours, 3 days">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="confidenceScore" class="form-label">Confidence Score (0-1)</label>
                                <input type="number" class="form-control" id="confidenceScore" min="0" max="1" step="0.01" placeholder="0.85">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelVersion" class="form-label">Model Version</label>
                                <input type="text" class="form-control" id="modelVersion" value="1.0" placeholder="1.0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="riskFactors" class="form-label">Risk Factors</label>
                        <textarea class="form-control" id="riskFactors" rows="2" placeholder="Enter risk factors separated by commas..."></textarea>
                        <small class="form-text text-muted">Separate multiple factors with commas</small>
                    </div>
                    <div class="mb-3">
                        <label for="predictionRecommendations" class="form-label">Recommendations</label>
                        <textarea class="form-control" id="predictionRecommendations" rows="3" placeholder="Enter recommendations separated by commas..."></textarea>
                        <small class="form-text text-muted">Separate multiple recommendations with commas</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePrediction()">Save Prediction</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global chart instances
    let charts = {
        riskTrend: null,
        location: null,
        time: null,
        radar: null,
        response: null,
        medication: null
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadMetrics();
        loadAllCharts();
        loadPredictionResults();
        loadSeizurePredictions();

        // Set up filter event listeners
        document.getElementById('dateRange').addEventListener('change', applyFilters);
        document.getElementById('pwidFilter').addEventListener('change', applyFilters);
        document.getElementById('locationFilter').addEventListener('change', applyFilters);
        document.getElementById('incidentType').addEventListener('change', applyFilters);
    });

    function getCurrentFilters() {
        return {
            dateRange: document.getElementById('dateRange').value,
            pwidFilter: document.getElementById('pwidFilter').value,
            locationFilter: document.getElementById('locationFilter').value,
            incidentType: document.getElementById('incidentType').value
        };
    }

    async function loadMetrics() {
        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/metrics?${queryParams}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                document.getElementById('totalIncidents').textContent = data.total_incidents || 0;
                document.getElementById('seizureCount').textContent = data.seizure_count || 0;
                document.getElementById('avgResponseTime').textContent = data.avg_response_time || '0m';
                document.getElementById('highRiskCases').textContent = data.high_risk_cases || 0;

                // Update change indicators
                updateChangeIndicator('incidentsChange', data.incidents_change || '0%');
                updateChangeIndicator('seizureChange', data.seizure_change || '0%');
                updateChangeIndicator('responseTimeChange', data.response_time_change || '0%');
                updateChangeIndicator('riskCasesChange', data.risk_cases_change || '0%');
            }
        } catch (error) {
            console.error('Error loading metrics:', error);
            // Set fallback values
            document.getElementById('totalIncidents').textContent = '24';
            document.getElementById('seizureCount').textContent = '19';
            document.getElementById('avgResponseTime').textContent = '13.3m';
            document.getElementById('highRiskCases').textContent = '0';
        }
    }

    function updateChangeIndicator(elementId, changeText) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = changeText;

            if (changeText.includes('+') || changeText.includes('increase')) {
                element.className = 'metric-change positive';
            } else if (changeText.includes('-') || changeText.includes('decrease')) {
                element.className = 'metric-change negative';
            } else {
                element.className = 'metric-change neutral';
            }
        }
    }

    async function loadAllCharts() {
        await Promise.all([
            loadRiskTrendChart(),
            loadLocationChart(),
            loadTimeChart(),
            loadRadarChart(),
            loadResponseChart(),
            loadMedicationChart()
        ]);
    }

    async function loadRiskTrendChart() {
        const ctx = document.getElementById('riskTrendChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/seizure-trends?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.riskTrend) {
                    charts.riskTrend.destroy();
                }

                charts.riskTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Risk Score',
                            data: data.risk_scores,
                            borderColor: '#4285f4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading risk trend chart:', error);
        }
    }

    async function loadLocationChart() {
        const ctx = document.getElementById('locationChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/location-distribution?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.location) {
                    charts.location.destroy();
                }

                charts.location = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.locations,
                        datasets: [{
                            data: data.counts,
                            backgroundColor: [
                                '#4285f4',
                                '#34a853',
                                '#ea4335',
                                '#fbbc04',
                                '#9aa0a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading location chart:', error);
        }
    }

    async function loadTimeChart() {
        const ctx = document.getElementById('timeChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/seizure-frequency?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.time) {
                    charts.time.destroy();
                }

                charts.time = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading time chart:', error);
        }
    }

    async function loadRadarChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/risk-factors?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.radar) {
                    charts.radar.destroy();
                }

                charts.radar = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading radar chart:', error);
        }
    }

    async function loadResponseChart() {
        const ctx = document.getElementById('responseChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/response-time?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.response) {
                    charts.response.destroy();
                }

                // Update datasets to handle null values properly
                const updatedDatasets = data.datasets.map(dataset => ({
                    ...dataset,
                    spanGaps: false,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 2,
                    fill: false
                }));
                
                charts.response = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: updatedDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                filter: function(tooltipItem) {
                                    return tooltipItem.parsed.y !== null;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Response Time (minutes)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading response chart:', error);
        }
    }

    async function loadMedicationChart() {
        const ctx = document.getElementById('medicationChart').getContext('2d');

        try {
            const filters = getCurrentFilters();
            const queryParams = new URLSearchParams(filters).toString();
            const response = await fetch(`/api/analytics/medication-compliance?${queryParams}`);
            const data = await response.json();

            if (data.success) {
                if (charts.medication) {
                    charts.medication.destroy();
                }

                charts.medication = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading medication chart:', error);
        }
    }

    function applyFilters() {
        loadMetrics();
        loadAllCharts();
    }

    function refreshAllData() {
        loadMetrics();
        loadAllCharts();
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }







    // AI Prediction Functions
    function runPredictionAnalysis() {
        const statusElement = document.getElementById('predictionStatus');
        const resultsElement = document.getElementById('predictionResults');
        
        if (statusElement) {
            statusElement.innerHTML = '<div class="status-indicator running"></div><span class="status-text">Running AI Analysis...</span>';
        }
        
        fetch('/api/analytics/run-prediction', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('AI analysis completed successfully!', 'success');
                loadPredictionResults();
            } else {
                showNotification(data.message || 'Error running AI analysis', 'error');
                if (statusElement) {
                    statusElement.innerHTML = '<div class="status-indicator error"></div><span class="status-text">Analysis Failed</span>';
                }
            }
        })
        .catch(error => {
            console.error('Error running AI analysis:', error);
            showNotification('Error running AI analysis', 'error');
            if (statusElement) {
                statusElement.innerHTML = '<div class="status-indicator error"></div><span class="status-text">Analysis Failed</span>';
            }
        });
    }

    function loadPredictionResults() {
        fetch('/api/analytics/prediction-results')
            .then(response => response.json())
            .then(data => {
                renderPredictionResults(data);
                const statusElement = document.getElementById('predictionStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<div class="status-indicator"></div><span class="status-text">Analysis Complete</span>';
                }
            })
            .catch(error => {
                console.error('Error loading prediction results:', error);
                showNotification('Error loading prediction results', 'error');
            });
    }

    function renderPredictionResults(data) {
        const resultsElement = document.getElementById('predictionResults');
        if (!resultsElement || !data.predictions) return;
        
        resultsElement.innerHTML = '';
        
        data.predictions.forEach(prediction => {
            const card = document.createElement('div');
            card.className = `prediction-card ${prediction.risk_level.toLowerCase()}-risk`;
            card.innerHTML = `
                <h5>${prediction.patient_id}</h5>
                <p><strong>Risk Level:</strong> <span class="risk-badge risk-${prediction.risk_level.toLowerCase()}">${prediction.risk_level}</span></p>
                <p><strong>Confidence:</strong> ${(prediction.confidence * 100).toFixed(1)}%</p>
                <p><strong>Next Seizure Prediction:</strong> ${prediction.next_seizure_prediction || 'N/A'}</p>
                <p><strong>Recommendations:</strong> ${prediction.recommendations || 'No specific recommendations'}</p>
            `;
            resultsElement.appendChild(card);
        });    }

    // Seizure Prediction Functions
    let currentPredictionId = null;
    let seizurePredictions = [];

    function loadSeizurePredictions() {
        fetch('/api/seizure-predictions')
            .then(response => response.json())
            .then(data => {
                seizurePredictions = data.predictions || [];
                renderSeizurePredictions(seizurePredictions);
            })
            .catch(error => {
                console.error('Error loading seizure predictions:', error);
                showNotification('Error loading seizure predictions', 'error');
            });
    }

    function renderSeizurePredictions(predictions) {
        const tbody = document.getElementById('seizurePredictionsTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        predictions.forEach(prediction => {
            const row = document.createElement('tr');
            const riskClass = prediction.risk_level ? prediction.risk_level.toLowerCase() : 'unknown';
            
            row.innerHTML = `
                <td>${prediction.patient_id || 'N/A'}</td>
                <td>${prediction.prediction_date ? new Date(prediction.prediction_date).toLocaleDateString() : 'N/A'}</td>
                <td><span class="badge bg-${getRiskColor(prediction.risk_level)}">${prediction.risk_level || 'Unknown'}</span></td>
                <td>${prediction.risk_score !== undefined ? prediction.risk_score.toFixed(1) : 'N/A'}</td>
                <td>${prediction.next_seizure_prediction || 'N/A'}</td>
                <td>${prediction.confidence_score !== undefined ? (prediction.confidence_score * 100).toFixed(1) + '%' : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editPrediction(${prediction.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePrediction(${prediction.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function getRiskColor(riskLevel) {
        switch(riskLevel?.toLowerCase()) {
            case 'low': return 'success';
            case 'medium': return 'warning';
            case 'high': return 'danger';
            case 'critical': return 'dark';
            default: return 'secondary';
        }
    }

    function openPredictionModal(predictionId = null) {
        currentPredictionId = predictionId;
        const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
        const title = document.getElementById('predictionModalTitle');
        
        if (predictionId) {
            title.textContent = 'Edit Seizure Prediction';
            loadPredictionData(predictionId);
        } else {
            title.textContent = 'Add New Seizure Prediction';
            clearPredictionForm();
        }
        
        modal.show();
    }

    function loadPredictionData(predictionId) {
        const prediction = seizurePredictions.find(p => p.id === predictionId);
        if (prediction) {
            document.getElementById('predictionPatientId').value = prediction.patient_id || '';
            document.getElementById('predictionRiskScore').value = prediction.risk_score || '';
            document.getElementById('predictionRiskLevel').value = prediction.risk_level || '';
            document.getElementById('nextSeizurePrediction').value = prediction.next_seizure_prediction || '';
            document.getElementById('confidenceScore').value = prediction.confidence_score || '';
            document.getElementById('modelVersion').value = prediction.model_version || '1.0';
            document.getElementById('riskFactors').value = Array.isArray(prediction.factors) ? prediction.factors.join(', ') : (prediction.factors || '');
            document.getElementById('predictionRecommendations').value = Array.isArray(prediction.recommendations) ? prediction.recommendations.join(', ') : (prediction.recommendations || '');
        }
    }

    function clearPredictionForm() {
        document.getElementById('predictionForm').reset();
        document.getElementById('modelVersion').value = '1.0';
    }

    function savePrediction() {
        const form = document.getElementById('predictionForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const predictionData = {
            patient_id: document.getElementById('predictionPatientId').value,
            risk_score: parseFloat(document.getElementById('predictionRiskScore').value),
            risk_level: document.getElementById('predictionRiskLevel').value,
            next_seizure_prediction: document.getElementById('nextSeizurePrediction').value,
            confidence_score: parseFloat(document.getElementById('confidenceScore').value) || null,
            model_version: document.getElementById('modelVersion').value || '1.0',
            factors: document.getElementById('riskFactors').value.split(',').map(f => f.trim()).filter(f => f),
            recommendations: document.getElementById('predictionRecommendations').value.split(',').map(r => r.trim()).filter(r => r)
        };

        const url = currentPredictionId ? `/api/seizure-predictions/${currentPredictionId}` : '/api/seizure-predictions';
        const method = currentPredictionId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(predictionData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(currentPredictionId ? 'Prediction updated successfully!' : 'Prediction created successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('predictionModal')).hide();
                loadSeizurePredictions();
            } else {
                showNotification(data.message || 'Error saving prediction', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving prediction:', error);
            showNotification('Error saving prediction', 'error');
        });
    }

    function editPrediction(predictionId) {
        openPredictionModal(predictionId);
    }

    function deletePrediction(predictionId) {
        if (confirm('Are you sure you want to delete this prediction?')) {
            fetch(`/api/seizure-predictions/${predictionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Prediction deleted successfully!', 'success');
                    loadSeizurePredictions();
                } else {
                    showNotification(data.message || 'Error deleting prediction', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting prediction:', error);
                showNotification('Error deleting prediction', 'error');
            });
        }
    }

    function refreshPredictions() {
        loadSeizurePredictions();
        showNotification('Predictions refreshed!', 'info');
    }

    function searchPredictions() {
        const searchTerm = document.getElementById('predictionSearch').value.toLowerCase();
        const riskFilter = document.getElementById('predictionRiskFilter').value;
        const timeFilter = document.getElementById('predictionTimeFilter').value;
        
        let filteredPredictions = seizurePredictions.filter(prediction => {
            const matchesSearch = !searchTerm || 
                prediction.patient_id?.toString().toLowerCase().includes(searchTerm) ||
                prediction.risk_level?.toLowerCase().includes(searchTerm);
            
            const matchesRisk = !riskFilter || prediction.risk_level?.toLowerCase() === riskFilter.toLowerCase();
            
            let matchesTime = true;
            if (timeFilter && prediction.prediction_date) {
                const predictionDate = new Date(prediction.prediction_date);
                const now = new Date();
                const daysDiff = (now - predictionDate) / (1000 * 60 * 60 * 24);
                
                switch(timeFilter) {
                    case 'today':
                        matchesTime = daysDiff < 1;
                        break;
                    case 'week':
                        matchesTime = daysDiff < 7;
                        break;
                    case 'month':
                        matchesTime = daysDiff < 30;
                        break;
                }
            }
            
            return matchesSearch && matchesRisk && matchesTime;
        });
        
        renderSeizurePredictions(filteredPredictions);
    }

    // Add event listeners for seizure predictions
    document.addEventListener('DOMContentLoaded', function() {
        // Load seizure predictions on page load
        loadSeizurePredictions();
        
        // Set up search and filter event listeners
        const searchInput = document.getElementById('predictionSearch');
        const riskFilter = document.getElementById('predictionRiskFilter');
        const timeFilter = document.getElementById('predictionTimeFilter');
        
        if (searchInput) {
            searchInput.addEventListener('input', searchPredictions);
        }
        if (riskFilter) {
            riskFilter.addEventListener('change', searchPredictions);
        }
        if (timeFilter) {
            timeFilter.addEventListener('change', searchPredictions);
        }
    });


</script>
{% endblock %}